<project name="Arduino" basedir="." default="deploy">

    <import file="../common.xml"/>

    <property name="sample_type" value="sensebot"/>
    <property name="data_source" value="SensebotDM_DB.h2.db"/>

    <target name="create-db" depends="clean">
        <property name="dbURL" value="jdbc:h2:file:${basedir}/${db.dir}/${data_source};DB_CLOSE_ON_EXIT=FALSE"/>

        <sql driver="org.h2.Driver" url="${dbURL}" userid="${db.username}" password="${db.password}"  autocommit="true" onerror="continue">
            <classpath>
                <pathelement location="${lib.dir}/h2-database-engine_1.2.140.wso2v3.jar"/>
            </classpath>
            <fileset file="dbscripts/${db.type}_${sample_type}.sql"/>
        </sql>
        <copy file="${db.dir}/${data_source}.h2.db" toDir="${target.db.dir}" overwrite="yes"/>

        <xmltask source="${iot.conf}" dest="${iot.conf}" report="true">
            <insert path="/IoTDeviceTypeConfigManager[1]">
                <![CDATA[
    <IotDeviceTypeConfig type="${sample_type}">
		<DatasourceName>jdbc/${data_source}</DatasourceName>
	</IotDeviceTypeConfig>
	            ]]>
            </insert>
        </xmltask>

    </target>

    <target name="deploy" depends="create-db">
        <copy toDir="${target.sketch.dir}/${sample_type}">
            <fileset dir="sketch"/>
        </copy>
        <copy toDir="${target.sketch.dir}/${sample_type}_wifi">
            <fileset dir="sketch_wifi"/>
        </copy>
        <copy toDir="${target.unit.dir}/${sample_type}">
            <fileset dir="units"/>
        </copy>
    </target>

    <target name="clean">
        <delete file="${target.db.dir}/${data_source}.h2.db"/>
        <delete dir="${target.sketch.dir}/${sample_type}"/>
        <delete dir="${target.sketch.dir}/${sample_type}_wifi"/>
        <delete dir="${target.unit.dir}/${sample_type}"/>
        <xmltask source="${iot.conf}" dest="${iot.conf}" report="true">
            <remove path="/IoTDeviceTypeConfigManager/IotDeviceTypeConfig[type='${sample_type}']"/>
        </xmltask>
    </target>

</project>